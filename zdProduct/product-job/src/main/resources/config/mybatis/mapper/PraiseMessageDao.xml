<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="PraiseMessageDaoImpl">
	
	<resultMap type="PraiseMessageModel" id="praiseMessageModel">
		<result property="id" column="id" javaType="java.lang.Long"/>
		<result property="productId" column="product_id" javaType="java.lang.Long"/>
		<result property="productCode" column="product_code" javaType="java.lang.String"/>
		<result property="productName" column="product_name" javaType="java.lang.String"/>
		<result property="praiseAccount" column="praise_account" javaType="java.lang.Integer"/>
		<result property="sendGrade" column="send_grade" javaType="java.lang.Integer"/>
		<result property="sendStatus" column="send_status" javaType="java.lang.Integer"/>
		<result property="retryNum" column="retry_num" javaType="java.lang.Integer"/>
		<result property="lastSendAccount" column="last_send_account" javaType="java.lang.Integer"/>
		<result property="lastSendTime" column="last_send_time" javaType="java.lang.Long"/>
		<result property="lastSendGrade" column="last_send_grade" javaType="java.lang.Integer"/>
		<result property="createTime" column="create_time" javaType="java.lang.Long"/>
		<result property="updateTime" column="update_time" javaType="java.lang.Long"/>
		<result property="supplierPhone" column="supplier_phone" javaType="java.lang.String"/>
		<result property="operatorPhone" column="operator_phone" javaType="java.lang.String"/>
	</resultMap>
	
	<sql id="query">
	        and t.send_status=#{sendStatus}   and  id <![CDATA[ % #{total} = #{remainder} ]]>
    </sql>
	
	<select id="queryOne" parameterType="PraiseMessageModel"
	resultMap="praiseMessageModel">
		SELECT
			product_id
		FROM  t_product_count t
		WHERE t.product_id = #{productId}
	</select>
	
	<select id="queryListPage" parameterType="PraiseMessageModel"
		resultMap="praiseMessageModel">
		select 
	          	product_id,
		        product_code,
		        product_name,
		        praise_account,
		        send_grade,
		        send_status,
		        retry_num,
		        last_send_account,
		        last_send_time,
		        last_send_grade,
				create_time,
				update_time,
				supplier_phone,
				operator_phone
	     from  t_praise_message_job t
		where 1=1
		<include refid="query"/>
	</select>
	
	<select id="countListPage" parameterType="PraiseMessageModel"
		resultType="java.lang.Long">
		select count(1) from  t_praise_message_job t
		where 1=1
		<include refid="query"/>
	 </select>
	
	<select id="getProductInfo" parameterType="PraiseMessageModel"
		resultMap="praiseMessageModel">
		SELECT
			t.product_code,
			t.product_name,
			t1.phone supplier_phone,
			t2.business_contacts_phone operator_phone
		FROM
			t_product t,
			t_supplier t1,
			t_supplier_shop t2
		WHERE
			t.supplier_id = t1.id
		AND t.shop_id = t2.id
		AND t.product_id = #{productId}
	</select>
	
    <insert id="insert" useGeneratedKeys="true" keyProperty="productId" parameterType="PraiseMessageModel">
		insert into  t_praise_message_job 
		(
	          			    
		        product_id,
		        product_code,
		        product_name,
		        praise_account,
		        send_grade,
		        send_status,
		        retry_num,
		        last_send_account,
		        last_send_time,
		        last_send_grade,
				create_time,
				update_time
				supplier_phone,
				operator_phone
        )
		values
		(
      			    
    			    #{productId},
    			    #{productCode},
    			    #{productName},
    				#{praiseAccount},
    			    #{sendGrade},
    			    #{sendStatus},
    			    #{retryNum},
    			    #{lastSendAccount},
    			    #{lastSendTime},
    			    #{lastSendGrade},
    			    #{createTime},
    			    #{updateTime}
					#{supplierPhone},
					#{operatorPhone}
        )
	</insert>

	<update id="update" parameterType="PraiseMessageModel">
		update  t_praise_message_job t 
		  <set>
			         
			         <if test="productCode != null  and productCode !=''">
				          t.product_code=#{productCode},
				    </if>
			         <if test="productName != null  and productName !=''">
				          t.product_name=#{productName},
				    </if>
			         <if test="praiseAccount != null  and praiseAccount !=''">
				          t.praise_account=#{praiseAccount},
				    </if>
				     <if test="sendGrade != null  and sendGrade !=''">
				          t.send_grade=#{sendGrade},
				    </if>
			         <if test="sendStatus != null  and sendStatus !=''">
				          t.send_status=#{sendStatus},
				    </if>
			         <if test="retryNum != null  and retryNum !=''">
				          t.retry_num=#{retryNum},
				    </if>
				    <if test="lastSendAccount !=null and lastSendAccount!='' ">
				    	t.last_send_account=#{lastSendAccount},
				    </if>
				    <if test="lastSendTime !=null and lastSendTime!='' ">
				    	t.last_send_time=#{lastSendTime},
				    </if>
				    <if test="lastSendGrade !=null and lastSendGrade!='' ">
				    	t.last_send_grade=#{lastSendGrade},
				    </if>
				    <if test="updateTime !=null and updateTime!='' ">
				    	t.update_time=#{updateTime},
				    </if>
				    <if test="supplierPhone !=null and supplierPhone!='' ">
				    	t.supplier_phone=#{supplierPhone},
				    </if>
				    <if test="operatorPhone !=null and operatorPhone!='' ">
				    	t.operator_phone=#{operatorPhone},
				    </if>
				    
				    <if test="productId != null  and productId !=''">
				          t.product_id=#{productId}
				    </if>
		    </set>
		where t.product_id = #{productId}
	</update>
	
	<update id="changeRetryNum">
		update t_praise_message_job t set retry_num=#{retryNum} where t.product_id=#{productId}
	</update>
</mapper>